[![Maven Central](https://img.shields.io/maven-central/v/io.github.fletchmckee.ktjni/ktjni-plugin)](https://search.maven.org/search?q=g:io.github.fletchmckee.ktjni) ![Build status](https://github.com/fletchmckee/ktjni/actions/workflows/build.yml/badge.svg)


# Ktjni

**Ktjni** is a Gradle plugin that generates JNI headers from Kotlin, Java, or Scala classes containing external native methods.

Manually writing JNI headers is tedious, error-prone, and a common source of runtime crashes due to signature mismatches. This plugin eliminates that pain by scanning compiled `.class` files using the [ASM](https://asm.ow2.io/) library to generate accurate, up-to-date headers that match your JVM method signatures.

Since all JVM languages compile native method declarations to the same core bytecode structure, Ktjni works consistently across Kotlin, Java, and Scala codebases, regardless of compiler-specific attributes or metadata differences.

> [!NOTE]
> **Beta limitations:** Header generation currently requires manual execution and does not yet automatically integrate with the build process.
>
> Currently the headers are generated in the project's build directory at the following path:
> ```
> {project.projectDir}/build/generated/sources/headers/{sourceType}/{sourceSet}
> ```
>
> **CI/CD Usage:** You can add header generation as a build step in your pipelines:
> ```yml
> - name: Generate JNI headers
>   run: ./gradlew generateJniHeaders
> ```

## Getting started

**1. Add Maven Central to your pluginManagment repositories**

```gradle
pluginManagement {
  repositories {
    // Currently this plugin is only published to `mavenCentral()`
    mavenCentral()
    gradlePluginPortal()
  }
}
```

**2. Add the Ktjni plugin to your project's build.gradle.kts**

```gradle
plugins {
  id("io.github.fletchmckee.ktjni") version "0.0.1-beta01"
}
```

**3. Run the following command to generate JNI headers for any files containing external native methods**

```console
./gradlew generateJniHeaders
```

## Example

The following Kotlin class would produce the below [JNI Header](#jni-header):

#### Kotlin
```kotlin
package com.example

class Crypto {
  external fun sha256(input: ByteArray): ByteArray
}
```

#### JNI Header:
```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_example_Crypto */

#ifndef _Included_com_example_Crypto
#define _Included_com_example_Crypto
#ifdef __cplusplus
extern "C" {
#endif

/*
 * Class:     com_example_Crypto
 * Method:    sha256
 * Signature: ([B)[B
 */
JNIEXPORT jbyteArray JNICALL Java_com_example_Crypto_sha256
  (JNIEnv *, jobject, jbyteArray);

#ifdef __cplusplus
}
#endif
#endif

```

<details>
<summary>Examples in Java and Scala that would produce the same header output</summary>
<p>

#### Java
```java
package com.example;

public class Crypto {
  public native byte[] sha256(byte[] input);
}
```

#### Scala
```scala
package com.example

class Crypto {
  @native
  def sha256(input: Array[Byte]): Array[Byte]
}
```
</p>
</details>

## Supported Plugins

- [x] **Kotlin JVM** (`org.jetbrains.kotlin.jvm`)
- [x] **Kotlin Multiplatform** (`org.jetbrains.kotlin.multiplatform`)
- [x] **Kotlin Android** (`org.jetbrains.kotlin.android`)
- [x] **Java** (via `java` or `java-library` plugins)
- [x] **Scala** (`scala` plugin)
- [ ] **Android build variants** (`com.android.library` or `com.android.application`) 
  - Currently supports Kotlin compilation in Android projects. Java compilation support for Android build variants is planned for a future release.
