[![Maven Central](https://img.shields.io/maven-central/v/io.github.fletchmckee.ktjni/ktjni-plugin)](https://search.maven.org/search?q=g:io.github.fletchmckee.ktjni) ![Build status](https://github.com/fletchmckee/ktjni/actions/workflows/build.yml/badge.svg)


# Ktjni

**Ktjni** is a Gradle plugin that generates JNI headers from Kotlin, Java, or Scala classes containing external native methods.

Manually writing JNI headers is tedious, error-prone, and a common source of runtime crashes due to signature mismatches. This plugin eliminates that pain by scanning compiled `.class` files using the [ASM](https://asm.ow2.io/) library to generate accurate, up-to-date headers that match your JVM method signatures.

Since all JVM languages compile native method declarations to the same core bytecode structure, Ktjni works consistently across Kotlin, Java, and Scala codebases, regardless of compiler-specific attributes or metadata differences.

> [!NOTE]
> Header generation currently requires manual execution and does not automatically integrate with the build process.
>
> **CI/CD Usage:** You can add header generation as a build step in your pipelines:
> ```yml
> - name: Generate JNI headers
>   run: ./gradlew generateJniHeaders
> ```

## Getting Started

**1. Add Maven Central to your pluginManagement repositories**

```gradle
pluginManagement {
  repositories {
    mavenCentral() // Release versions
    maven { url = uri("https://central.sonatype.com/repository/maven-snapshots/") } // SNAPSHOT versions
  }
}
```

**2. Add the Ktjni plugin to your project's build.gradle.kts and choose your header output directory location (optional)**

```gradle
plugins {
  id("io.github.fletchmckee.ktjni") version "0.1.0"
}

ktjni {
  // Optional
  outputDir = layout.buildDirectory.dir("custom")
}
```

**Note:** If no `outputDir` is specified, it defaults to the following location:
```
{projectDir}/build/generated/ktjni/{sourceType}/{sourceSet}
```

Whether using the default `outputDir` or a custom location, the `sourceType` and `sourceSet` are added as subdirectories for configuration cache correctness.

## Usage
**Run the following aggregate command to generate JNI headers for any files containing external native methods for all variants**

```console
./gradlew generateJniHeaders
```

> [!NOTE]
> The above command is an aggregate task that triggers all variant-specific JNI header tasks. Because header generation depends on `.class`
> files, running this task will also compile the corresponding source sets if not already compiled.
> For a more fine-grained approach, you can discover the relevant Ktjni commands by running the following:
> ```console
> ./gradlew tasks --group "ktjni"
> ```
> And then you can select the relevant tasks based on the above output. For example:
> ```console
> ./gradlew :app:generateKotlinReleaseJniHeaders
> ```

## Example

The following Kotlin class would produce the below [JNI Header](#jni-header):

#### Kotlin
```kotlin
package com.example

class Crypto {
  external fun sha256(input: ByteArray): ByteArray
}
```

<details>
<summary>Examples in Java and Scala that would produce the same header output</summary>
<p>

#### Java
```java
package com.example;

public class Crypto {
  public native byte[] sha256(byte[] input);
}
```

#### Scala
```scala
package com.example

class Crypto {
  @native
  def sha256(input: Array[Byte]): Array[Byte]
}
```
</p>
</details>

#### JNI Header
```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_example_Crypto */

#ifndef _Included_com_example_Crypto
#define _Included_com_example_Crypto
#ifdef __cplusplus
extern "C" {
#endif

/*
 * Class:     com_example_Crypto
 * Method:    sha256
 * Signature: ([B)[B
 */
JNIEXPORT jbyteArray JNICALL Java_com_example_Crypto_sha256
  (JNIEnv *, jobject, jbyteArray);

#ifdef __cplusplus
}
#endif
#endif

```

## Supported Plugins

- [x] **Kotlin JVM** (`org.jetbrains.kotlin.jvm`)
- [x] **Kotlin Multiplatform** (`org.jetbrains.kotlin.multiplatform`)
- [x] **Kotlin Android** (`org.jetbrains.kotlin.android`)
- [x] **Java** (via `java` or `java-library` plugins)
- [x] **Scala** (`scala` plugin)
- [x] **Android build variants** (`com.android.library` or `com.android.application`)
