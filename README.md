![Build status](https://github.com/fletchmckee/ktjni/actions/workflows/build.yml/badge.svg)


# Ktjni

**Ktjni** is a Gradle plugin that generates JNI headers from Kotlin, Java, or Scala classes containing external native methods.  

> [!WARNING]
> This plugin is in its alpha stage. Header generation currently requires manual execution and does not yet integrate automatically with the build process.
>
> Currently the headers are generated in the module's build directory at the following path:
> ```
> ~/build/generated/headers/source/{language}/{compileTaskName}
> ```
>
> This is subject to change.

## Usage

#### 1. Add the plugin to your build.gradle.kts module(s) containing external native methods

```gradle
plugins {
  id("io.github.fletchmckee.ktjni") version "0.0.1-alpha01"
}
```

#### 2. Run the following command to generate JNI headers for any files containing native methods

```bash
./gradlew generateJniHeaders
```

## Example

Ktjni scans `.class` files using the [ASM](https://asm.ow2.io/) library. While different JVM languages produce `.class` files with varying metadata and compiler-specific attributes, they all compile native method declarations to the same core JVM method signature.

The following Kotlin class would produce the below [JNI Header](#jni-header):

#### Kotlin
```kotlin
package com.example

class Crypto {
  external fun sha256(input: ByteArray): ByteArray
}
```

#### JNI Header:
```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_example_Crypto */

#ifndef _Included_com_example_Crypto
#define _Included_com_example_Crypto
#ifdef __cplusplus
extern "C" {
#endif

/*
 * Class:     com_example_Crypto
 * Method:    sha256
 * Signature: ([B)[B
 */
JNIEXPORT jbyteArray JNICALL Java_com_example_Crypto_sha256
  (JNIEnv *, jobject, jbyteArray);

#ifdef __cplusplus
}
#endif
#endif

```

<details>
<summary>Examples in Java and Scala that would produce the same header output</summary>
<p>

#### Java
```java
package com.example;

public class Crypto {
    public native byte[] sha256(byte[] input);
}
```

#### Scala
```scala
package com.example

class Crypto {
  @native
  def sha256(input: Array[Byte]): Array[Byte]
}
```
</p>
</details>

## Roadmap
> [!NOTE]
> The current alpha version requires manual header generation. The goal is to integrate this process automatically into the build lifecycle, so headers are generated during compilation without manual intervention. 
> This automatic integration is currently a work in progress.
>
> However, header generation can be added as a build step in your CI/CD pipelines by running the command before any that would depend on it:
>
>```yaml
>  - name: Generate JNI headers
>    run: ./gradlew generateJniHeaders
>```
